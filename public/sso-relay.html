<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SSO Relay</title>
    <script>
      // sso-relay.html
      // This page is intended to be the final redirect target after OAuth provider
      // redirects back to the frontend. It posts a message to the opener window
      // (the page that opened the popup) and then closes itself.

      (function () {
        try {
          const params = new URLSearchParams(window.location.search);
          const state = params.get('state') || null;
          const success = !params.get('error');

          // Determine the allowed origin for security. Default to current origin.
          // If your opener uses a different host, replace allowedOrigin accordingly.
          const allowedOrigin = window.location.origin;

          const message = {
            type: 'SSO_COMPLETE',
            success: success,
            state: state,
            timestamp: Date.now(),
          };

          // Helper: notify opener about authenticated user state.
          // Do NOT persist tokens to localStorage here. Backend sets HttpOnly cookies.
          const notifyOpenerWithUser = async () => {
            try {
              const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
              const backend = isLocal ? 'http://localhost:5001' : 'https://api.vikareta.com';

              let res = await fetch(`${backend}/api/auth/me`, { credentials: 'include' });
              if (res.status === 401) {
                // Attempt a token refresh using refresh cookie and retry
                try {
                  await fetch(`${backend}/csrf-token`, { credentials: 'include' });
                } catch (e) {}
                await fetch(`${backend}/api/auth/refresh`, { method: 'POST', credentials: 'include' });
                res = await fetch(`${backend}/api/auth/me`, { credentials: 'include' });
              }

              const data = await res.json().catch(() => null);
              // Post the user object (or null) to the opener so it can initialize the SSO client
              if (window.opener && !window.opener.closed) {
                window.opener.postMessage({ type: 'SSO_USER', data: data || null }, window.location.origin);
              }
            } catch (e) {
              if (window.opener && !window.opener.closed) {
                window.opener.postMessage({ type: 'SSO_USER', data: null }, window.location.origin);
              }
            }
          };

          // Determine post-auth redirect target
          const getReturnUrl = () => {
            try {
              const stored = localStorage.getItem('auth_return_url');
              if (stored) return stored;
            } catch {}
            return '/';
          };

          if (window.opener && !window.opener.closed) {
            // Popup flow: notify opener and close
            window.opener.postMessage(message, allowedOrigin);
            setTimeout(() => { try { window.close(); } catch (e) {} }, 200);
          } else {
            // Full-page redirect flow: inform opener (or handle client) then navigate back
            (async () => {
              await notifyOpenerWithUser();
              const target = getReturnUrl();
              try { localStorage.removeItem('auth_return_url'); } catch {}
              window.location.replace(target);
            })();
          }

          // Try to give a short UX for users who land here directly
          document.addEventListener('DOMContentLoaded', () => {
            const el = document.getElementById('status');
            if (el) el.textContent = success ? 'Authentication successful — you may close this window.' : 'Authentication failed — you may close this window.';
          });

          // If still here and opener exists, attempt to close as a fallback
          if (window.opener && !window.opener.closed) {
            setTimeout(() => { try { window.close(); } catch (e) {} }, 700);
          }
        } catch (err) {
          // silence errors
        }
      })();
    </script>
  </head>
  <body>
    <div style="font-family: system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; padding: 24px;">
      <h2 id="status">Completing authentication...</h2>
      <p>If this page does not close automatically, you may close it manually and return to the application.</p>
    </div>
  </body>
</html>
