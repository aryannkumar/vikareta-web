<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SSO Popup Demo</title>
    <style>
      body { font-family: system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; padding: 24px; }
      button { padding: 10px 14px; margin: 6px; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <h1>SSO Popup Demo</h1>
    <p>Use these buttons to test popup-based SSO flows. After the provider flow completes, the popup will notify this window and we'll fetch the current user.</p>

    <div>
      <button id="google">Continue with Google</button>
      <button id="linkedin">Continue with LinkedIn</button>
      <button id="digilocker">Continue with DigiLocker</button>
    </div>

    <h3>Status</h3>
    <div id="status">idle</div>

    <h3>User</h3>
    <pre id="user">not fetched</pre>

    <script>
      const popupOptions = 'width=600,height=700,menubar=no,toolbar=no,location=no,status=no';

      function openSSOPopup(path) {
        const state = encodeURIComponent(window.location.href);
        const url = `${path}?state=${state}`;
        const popup = window.open(url, 'sso', popupOptions);
        if (!popup) {
          document.getElementById('status').textContent = 'Popup blocked';
          return;
        }

        document.getElementById('status').textContent = 'Popup opened, waiting for auth...';

        // Listen for message from sso-relay.html
        function onMessage(e) {
          try {
            // Security: ensure origin matches expected (current origin)
            if (e.origin !== window.location.origin) return;
            const data = e.data || {};
            if (data.type === 'SSO_COMPLETE') {
              document.getElementById('status').textContent = data.success ? 'Authentication succeeded' : 'Authentication failed';
              // Close popup if still open
              try { popup.close(); } catch (err) {}
              // Attempt to fetch current user
              fetch('/api/auth/me', { credentials: 'include' })
                .then(r => r.json())
                .then(json => {
                  document.getElementById('user').textContent = JSON.stringify(json, null, 2);
                }).catch(err => {
                  document.getElementById('user').textContent = 'Failed to fetch /api/auth/me: ' + err;
                });

              window.removeEventListener('message', onMessage);
            }
          } catch (err) {
            // ignore
          }
        }

        window.addEventListener('message', onMessage, false);

        // Fallback: poll until popup closed and then try to fetch user
        const timer = setInterval(() => {
          if (!popup || popup.closed) {
            clearInterval(timer);
            // Try to fetch user anyway
            fetch('/api/auth/me', { credentials: 'include' })
              .then(r => r.json())
              .then(json => {
                document.getElementById('user').textContent = JSON.stringify(json, null, 2);
              }).catch(err => {
                // ignore
              });
          }
        }, 500);
      }

      document.getElementById('google').addEventListener('click', () => openSSOPopup('/api/auth/google'));
      document.getElementById('linkedin').addEventListener('click', () => openSSOPopup('/api/auth/linkedin'));
      document.getElementById('digilocker').addEventListener('click', () => openSSOPopup('/api/auth/digilocker'));
    </script>
  </body>
</html>
